# 数据库项目设计文档 (四)：物理结构设计 (SQL代码)

## 1. 数据库选型
*   **数据库系统**：SQLite 3
*   **选型理由**：
    1.  **轻量级与零配置**：无需安装服务器，单文件存储，非常适合个人桌面应用（MVP）。
    2.  **跨平台支持**：完美适配 Electron、Flutter 等客户端框架。
    3.  **数据主权**：用户可以直接复制 `.db` 文件进行备份，符合项目“数据掌握在用户手中”的理念。
    4.  **功能足够**：支持事务、外键约束和 JSON 处理，满足本项目需求。

## 2. DDL 建表语句 (Data Definition Language)

以下 SQL 代码基于 SQLite 语法编写。
*注：SQLite 中使用 `TEXT` 类型存储 UUID 和 ISO8601 时间字符串。*

```sql
-- 开启外键约束支持 (SQLite 默认关闭，需显式开启)
PRAGMA foreign_keys = ON;

-- ==========================================
-- 1. 基础实体表
-- ==========================================

-- 用户表
CREATE TABLE users (
    user_id TEXT PRIMARY KEY,       -- UUID
    username TEXT NOT NULL UNIQUE,  -- 用户名不可重复
    created_at TEXT DEFAULT (datetime('now', 'localtime'))
);

-- 设备表
CREATE TABLE devices (
    device_id TEXT PRIMARY KEY,     -- UUID
    user_id TEXT NOT NULL,
    device_name TEXT NOT NULL,      -- 如 "My MacBook"
    device_type TEXT,               -- 'PC', 'Mobile', 'Tablet'
    last_sync_time TEXT,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- 文件夹表 (虚拟层级)
CREATE TABLE folders (
    folder_id TEXT PRIMARY KEY,     -- UUID
    user_id TEXT NOT NULL,
    parent_id TEXT,                 -- 父文件夹ID，NULL表示根目录
    folder_name TEXT NOT NULL,
    created_at TEXT DEFAULT (datetime('now', 'localtime')),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES folders(folder_id) ON DELETE RESTRICT
);

-- 标签表
CREATE TABLE tags (
    tag_id TEXT PRIMARY KEY,        -- UUID
    user_id TEXT NOT NULL,
    tag_name TEXT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    UNIQUE(user_id, tag_name)       -- 同一用户下标签名唯一
);

-- ==========================================
-- 2. 核心业务表
-- ==========================================

-- 媒体项表 (逻辑资源)
CREATE TABLE media_items (
    item_id TEXT PRIMARY KEY,       -- UUID
    user_id TEXT NOT NULL,
    folder_id TEXT,                 -- 所属文件夹，NULL表示未分类
    title TEXT NOT NULL,
    media_type TEXT,                -- 'Video', 'Image', 'Doc', 'Web'
    description TEXT,               -- 备注/描述
    created_at TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at TEXT DEFAULT (datetime('now', 'localtime')),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (folder_id) REFERENCES folders(folder_id) ON DELETE SET NULL
);

-- 存储位置表 (物理路径/URL)
CREATE TABLE storage_locations (
    location_id TEXT PRIMARY KEY,   -- UUID
    item_id TEXT NOT NULL,
    device_id TEXT,                 -- Web资源可为NULL
    storage_type TEXT NOT NULL CHECK (storage_type IN ('Local', 'Web')),
    path TEXT NOT NULL,             -- 绝对路径 或 URL
    access_info TEXT,               -- 附加访问信息 (如 "需VPN")
    is_available INTEGER DEFAULT 1, -- 0=不可用, 1=可用 (布尔值)
    FOREIGN KEY (item_id) REFERENCES media_items(item_id) ON DELETE CASCADE,
    FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE
);

-- ==========================================
-- 3. 关联表
-- ==========================================

-- 媒体-标签关联表
CREATE TABLE media_tags (
    item_id TEXT NOT NULL,
    tag_id TEXT NOT NULL,
    PRIMARY KEY (item_id, tag_id),  -- 复合主键
    FOREIGN KEY (item_id) REFERENCES media_items(item_id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(tag_id) ON DELETE CASCADE
);
```

## 3. 索引设计 (Index Design)

为了提升查询性能，特别是针对外键连接和常用搜索字段建立索引。

```sql
-- 外键索引 (提升 JOIN 性能)
CREATE INDEX idx_devices_user_id ON devices(user_id);
CREATE INDEX idx_folders_parent_id ON folders(parent_id);
CREATE INDEX idx_media_items_folder_id ON media_items(folder_id);
CREATE INDEX idx_storage_locations_item_id ON storage_locations(item_id);
CREATE INDEX idx_storage_locations_device_id ON storage_locations(device_id);

-- 业务搜索索引 (提升 WHERE/ORDER BY 性能)
CREATE INDEX idx_media_items_title ON media_items(title);       -- 按标题搜索
CREATE INDEX idx_media_items_type ON media_items(media_type);   -- 按类型筛选
CREATE INDEX idx_tags_tag_name ON tags(tag_name);               -- 标签自动补全
```

## 4. 常用视图 (Views)

创建视图以简化应用层的复杂查询。

### 4.1 媒体库概览视图 (`v_media_library`)
展示媒体项的基本信息、所属文件夹名以及拥有的存储副本数量。

```sql
CREATE VIEW v_media_library AS
SELECT 
    m.item_id,
    m.title,
    m.media_type,
    m.created_at,
    f.folder_name,
    COUNT(sl.location_id) as copy_count  -- 副本数量
FROM media_items m
LEFT JOIN folders f ON m.folder_id = f.folder_id
LEFT JOIN storage_locations sl ON m.item_id = sl.item_id
GROUP BY m.item_id;
```

### 4.2 本地文件路径视图 (`v_local_files`)
快速查询当前设备上所有可访问的本地文件路径（应用层需在查询时过滤 `device_id`）。

```sql
CREATE VIEW v_local_files AS
SELECT 
    m.item_id,
    m.title,
    sl.path,
    sl.device_id
FROM media_items m
JOIN storage_locations sl ON m.item_id = sl.item_id
WHERE sl.storage_type = 'Local' AND sl.is_available = 1;
```
